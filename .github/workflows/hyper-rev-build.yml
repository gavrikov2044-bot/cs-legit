name: Build hyper-reV

on:
  push:
    branches: [main]
    paths:
      - 'hyper-rev/**'
      - '.github/workflows/hyper-rev-build.yml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # JOB 1: Clone and build EDK2 (shared)
  # ============================================
  prepare:
    name: Prepare & Build EDK2
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install NASM
      run: |
        $nasmVersion = "2.16.01"
        $nasmUrl = "https://www.nasm.us/pub/nasm/releasebuilds/$nasmVersion/win64/nasm-$nasmVersion-win64.zip"
        $downloadPath = "$env:TEMP\nasm.zip"
        $extractPath = "C:\NASM"
        
        Write-Host "Downloading NASM $nasmVersion..."
        Invoke-WebRequest -Uri $nasmUrl -OutFile $downloadPath -UseBasicParsing
        
        Write-Host "Extracting NASM..."
        Expand-Archive -Path $downloadPath -DestinationPath "C:\" -Force
        Rename-Item "C:\nasm-$nasmVersion" $extractPath
        
        echo "NASM_PREFIX=$extractPath\" >> $env:GITHUB_ENV
        echo "$extractPath" >> $env:GITHUB_PATH
        
        & "$extractPath\nasm.exe" -v

    - name: Clone hyper-reV
      run: |
        mkdir hyper-rev-src
        cd hyper-rev-src
        
        git clone https://github.com/noahware/hyper-reV.git
        cd hyper-reV
        
        git clone https://github.com/ionescu007/edk2.git uefi-boot/ext/edk2/src
        git clone --branch OpenSSL_1_1_0-stable https://github.com/openssl/openssl.git uefi-boot/ext/openssl

    - name: Cache EDK2
      id: cache-edk2
      uses: actions/cache@v4
      with:
        path: hyper-rev-src/hyper-reV/uefi-boot/ext/edk2/build/x64
        key: edk2-v1-${{ runner.os }}

    - name: Build EDK2 Libraries
      if: steps.cache-edk2.outputs.cache-hit != 'true'
      run: |
        cd hyper-rev-src\hyper-reV\uefi-boot\ext\edk2\build
        msbuild EDK-II.sln /p:Configuration=Release /p:Platform=x64 /m /v:minimal

    - name: Upload prepared source
      uses: actions/upload-artifact@v4
      with:
        name: hyper-rev-source
        path: hyper-rev-src/
        retention-days: 1

  # ============================================
  # JOB 2: Build for Intel
  # ============================================
  build-intel:
    name: Build for Intel
    runs-on: windows-latest
    needs: prepare
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install NASM
      run: |
        $nasmVersion = "2.16.01"
        $nasmUrl = "https://www.nasm.us/pub/nasm/releasebuilds/$nasmVersion/win64/nasm-$nasmVersion-win64.zip"
        Invoke-WebRequest -Uri $nasmUrl -OutFile "$env:TEMP\nasm.zip" -UseBasicParsing
        Expand-Archive -Path "$env:TEMP\nasm.zip" -DestinationPath "C:\" -Force
        Rename-Item "C:\nasm-$nasmVersion" "C:\NASM"
        echo "NASM_PREFIX=C:\NASM\" >> $env:GITHUB_ENV
        echo "C:\NASM" >> $env:GITHUB_PATH

    - name: Download prepared source
      uses: actions/download-artifact@v4
      with:
        name: hyper-rev-source
        path: hyper-rev-src/

    - name: Configure for Intel
      run: |
        $configFile = "hyper-rev-src\hyper-reV\hyperv-attachment\src\arch_config.h"
        
        if (Test-Path $configFile) {
          $content = Get-Content $configFile -Raw
          $content = $content -replace '//\s*#define\s+_INTELMACHINE', '#define _INTELMACHINE'
          $content = $content -replace '#define\s+_AMDMACHINE', '//#define _AMDMACHINE'
          Set-Content $configFile $content
          Write-Host "Configured for Intel"
        } else {
          Write-Host "arch_config.h not found, creating..."
          $archContent = "#pragma once`n#define _INTELMACHINE`n//#define _AMDMACHINE"
          Set-Content $configFile $archContent -Encoding utf8
        }

    - name: Build uefi-boot.efi
      run: |
        cd hyper-rev-src\hyper-reV\uefi-boot
        if (Test-Path "uefi-boot.sln") {
          msbuild uefi-boot.sln /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        } else {
          Write-Host "Solution not found"
          Get-ChildItem -Recurse -Filter "*.sln"
        }
      continue-on-error: true

    - name: Build hyperv-attachment.dll
      run: |
        cd hyper-rev-src\hyper-reV\hyperv-attachment
        if (Test-Path "hyperv-attachment.sln") {
          msbuild hyperv-attachment.sln /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        } else {
          Write-Host "Solution not found"
          Get-ChildItem -Recurse -Filter "*.sln"
        }
      continue-on-error: true

    - name: Prepare Intel Package
      run: |
        mkdir hyper-rev-intel
        mkdir hyper-rev-intel\scripts
        
        Get-ChildItem -Path hyper-rev-src -Recurse -Filter "uefi-boot.efi" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-intel\" }
        Get-ChildItem -Path hyper-rev-src -Recurse -Filter "hyperv-attachment.dll" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-intel\" }
        
        Copy-Item "hyper-rev\scripts\*" "hyper-rev-intel\scripts\" -ErrorAction SilentlyContinue
        Copy-Item "hyper-rev\README.md" "hyper-rev-intel\" -ErrorAction SilentlyContinue
        
        $buildInfo = "hyper-reV Package (Intel)`nArchitecture: Intel (EPT)`nBuild Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Set-Content "hyper-rev-intel\BUILD_INFO.txt" $buildInfo
        
        dir hyper-rev-intel

    - name: Upload Intel Package
      uses: actions/upload-artifact@v4
      with:
        name: hyper-rev-intel
        path: hyper-rev-intel/
        retention-days: 30

  # ============================================
  # JOB 3: Build for AMD
  # ============================================
  build-amd:
    name: Build for AMD
    runs-on: windows-latest
    needs: prepare
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install NASM
      run: |
        $nasmVersion = "2.16.01"
        $nasmUrl = "https://www.nasm.us/pub/nasm/releasebuilds/$nasmVersion/win64/nasm-$nasmVersion-win64.zip"
        Invoke-WebRequest -Uri $nasmUrl -OutFile "$env:TEMP\nasm.zip" -UseBasicParsing
        Expand-Archive -Path "$env:TEMP\nasm.zip" -DestinationPath "C:\" -Force
        Rename-Item "C:\nasm-$nasmVersion" "C:\NASM"
        echo "NASM_PREFIX=C:\NASM\" >> $env:GITHUB_ENV
        echo "C:\NASM" >> $env:GITHUB_PATH

    - name: Download prepared source
      uses: actions/download-artifact@v4
      with:
        name: hyper-rev-source
        path: hyper-rev-src/

    - name: Configure for AMD
      run: |
        $configFile = "hyper-rev-src\hyper-reV\hyperv-attachment\src\arch_config.h"
        
        if (Test-Path $configFile) {
          $content = Get-Content $configFile -Raw
          $content = $content -replace '#define\s+_INTELMACHINE', '//#define _INTELMACHINE'
          $content = $content -replace '//\s*#define\s+_AMDMACHINE', '#define _AMDMACHINE'
          Set-Content $configFile $content
          Write-Host "Configured for AMD"
        } else {
          Write-Host "arch_config.h not found, creating..."
          $archContent = "#pragma once`n//#define _INTELMACHINE`n#define _AMDMACHINE"
          Set-Content $configFile $archContent -Encoding utf8
        }

    - name: Build uefi-boot.efi
      run: |
        cd hyper-rev-src\hyper-reV\uefi-boot
        if (Test-Path "uefi-boot.sln") {
          msbuild uefi-boot.sln /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        }
      continue-on-error: true

    - name: Build hyperv-attachment.dll
      run: |
        cd hyper-rev-src\hyper-reV\hyperv-attachment
        if (Test-Path "hyperv-attachment.sln") {
          msbuild hyperv-attachment.sln /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        }
      continue-on-error: true

    - name: Prepare AMD Package
      run: |
        mkdir hyper-rev-amd
        mkdir hyper-rev-amd\scripts
        
        Get-ChildItem -Path hyper-rev-src -Recurse -Filter "uefi-boot.efi" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-amd\" }
        Get-ChildItem -Path hyper-rev-src -Recurse -Filter "hyperv-attachment.dll" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-amd\" }
        
        Copy-Item "hyper-rev\scripts\*" "hyper-rev-amd\scripts\" -ErrorAction SilentlyContinue
        Copy-Item "hyper-rev\README.md" "hyper-rev-amd\" -ErrorAction SilentlyContinue
        
        $buildInfo = "hyper-reV Package (AMD)`nArchitecture: AMD (NPT)`nBuild Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Set-Content "hyper-rev-amd\BUILD_INFO.txt" $buildInfo
        
        dir hyper-rev-amd

    - name: Upload AMD Package
      uses: actions/upload-artifact@v4
      with:
        name: hyper-rev-amd
        path: hyper-rev-amd/
        retention-days: 30

  # ============================================
  # JOB 4: Build Cheat
  # ============================================
  build-cheat:
    name: Build Cheat (hyper-reV support)
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          cheats/externa-rust-v2/target
        key: cargo-${{ runner.os }}-${{ hashFiles('cheats/externa-rust-v2/Cargo.lock') }}

    - name: Build Cheat
      run: |
        cd cheats\externa-rust-v2
        cargo build --release

    - name: Upload Cheat
      uses: actions/upload-artifact@v4
      with:
        name: externa-rust-v2
        path: cheats/externa-rust-v2/target/release/externa-rust-v2.exe
        retention-days: 30
