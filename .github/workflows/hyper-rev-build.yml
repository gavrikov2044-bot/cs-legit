name: Build hyper-reV

on:
  push:
    branches: [main]
    paths:
      - 'hyper-rev/**'
      - '.github/workflows/hyper-rev-build.yml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # JOB 1: Prepare - Clone and build EDK2
  # ============================================
  prepare:
    name: Prepare & Build EDK2
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install NASM
      run: |
        $nasmVersion = "2.16.01"
        $nasmUrl = "https://www.nasm.us/pub/nasm/releasebuilds/$nasmVersion/win64/nasm-$nasmVersion-win64.zip"
        Invoke-WebRequest -Uri $nasmUrl -OutFile "$env:TEMP\nasm.zip" -UseBasicParsing
        Expand-Archive -Path "$env:TEMP\nasm.zip" -DestinationPath "C:\" -Force
        Rename-Item "C:\nasm-$nasmVersion" "C:\NASM"
        echo "NASM_PREFIX=C:\NASM\" >> $env:GITHUB_ENV
        echo "C:\NASM" >> $env:GITHUB_PATH
        & "C:\NASM\nasm.exe" -v

    - name: Clone hyper-reV with submodules
      run: |
        Write-Host "Cloning hyper-reV from official GitHub..."
        git clone --recurse-submodules https://github.com/noahware/hyper-reV.git hyper-rev-build
        
        cd hyper-rev-build
        
        if (-not (Test-Path "uefi-boot\ext\edk2\src")) {
          Write-Host "Cloning EDK2 manually..."
          mkdir -p uefi-boot\ext\edk2 -Force
          git clone https://github.com/ionescu007/edk2.git uefi-boot/ext/edk2/src
        }
        
        if (-not (Test-Path "uefi-boot\ext\openssl")) {
          Write-Host "Cloning OpenSSL manually..."
          git clone --branch OpenSSL_1_1_0-stable https://github.com/openssl/openssl.git uefi-boot/ext/openssl
        }
        
        Write-Host "Repository structure:"
        Get-ChildItem

    - name: Cache EDK2
      id: cache-edk2
      uses: actions/cache@v4
      with:
        path: hyper-rev-build/uefi-boot/ext/edk2/build/x64
        key: edk2-v3-${{ runner.os }}

    - name: Build EDK2 Libraries
      if: steps.cache-edk2.outputs.cache-hit != 'true'
      run: |
        $edkPath = "hyper-rev-build\uefi-boot\ext\edk2\build"
        if (Test-Path "$edkPath\EDK-II.sln") {
          cd $edkPath
          msbuild EDK-II.sln /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        } elseif (Test-Path "hyper-rev-build\uefi-boot\ext\edk2\src\build\EDK-II.sln") {
          cd "hyper-rev-build\uefi-boot\ext\edk2\src\build"
          msbuild EDK-II.sln /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        } else {
          Write-Host "EDK-II.sln not found"
          Get-ChildItem -Path hyper-rev-build -Recurse -Filter "*.sln" | Select-Object -First 10
        }
      continue-on-error: true

    - name: Upload prepared source
      uses: actions/upload-artifact@v4
      with:
        name: hyper-rev-source
        path: hyper-rev-build/
        retention-days: 1

  # ============================================
  # JOB 2: Build for Intel
  # ============================================
  build-intel:
    name: Build for Intel (EPT)
    runs-on: windows-latest
    needs: prepare
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install NASM
      run: |
        $nasmVersion = "2.16.01"
        Invoke-WebRequest -Uri "https://www.nasm.us/pub/nasm/releasebuilds/$nasmVersion/win64/nasm-$nasmVersion-win64.zip" -OutFile "$env:TEMP\nasm.zip" -UseBasicParsing
        Expand-Archive -Path "$env:TEMP\nasm.zip" -DestinationPath "C:\" -Force
        Rename-Item "C:\nasm-$nasmVersion" "C:\NASM"
        echo "NASM_PREFIX=C:\NASM\" >> $env:GITHUB_ENV
        echo "C:\NASM" >> $env:GITHUB_PATH

    - name: Download prepared source
      uses: actions/download-artifact@v4
      with:
        name: hyper-rev-source
        path: hyper-rev-build/

    - name: Configure for Intel
      run: |
        $configFile = "hyper-rev-build\hyperv-attachment\src\arch_config.h"
        
        if (Test-Path $configFile) {
          $content = Get-Content $configFile -Raw
          $content = $content -replace '//\s*#define\s+_INTELMACHINE', '#define _INTELMACHINE'
          $content = $content -replace '#define\s+_AMDMACHINE', '//#define _AMDMACHINE'
          Set-Content $configFile $content
          Write-Host "Configured for Intel"
          Get-Content $configFile
        } else {
          Write-Host "Creating arch_config.h for Intel..."
          New-Item -Path (Split-Path $configFile) -ItemType Directory -Force
          Set-Content $configFile "#pragma once`n#define _INTELMACHINE`n//#define _AMDMACHINE"
        }

    - name: Build uefi-boot.efi
      run: |
        cd hyper-rev-build\uefi-boot
        $slnFile = Get-ChildItem -Filter "*.sln" | Select-Object -First 1
        if ($slnFile) {
          Write-Host "Building $($slnFile.Name)..."
          msbuild $slnFile.Name /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        } else {
          Write-Host "No solution file found in uefi-boot"
          Get-ChildItem
        }
      continue-on-error: true

    - name: Build hyperv-attachment.dll
      run: |
        cd hyper-rev-build\hyperv-attachment
        $slnFile = Get-ChildItem -Filter "*.sln" | Select-Object -First 1
        if ($slnFile) {
          Write-Host "Building $($slnFile.Name)..."
          msbuild $slnFile.Name /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        } else {
          Write-Host "No solution file in hyperv-attachment, trying vcxproj..."
          $vcxFile = Get-ChildItem -Filter "*.vcxproj" | Select-Object -First 1
          if ($vcxFile) {
            msbuild $vcxFile.Name /p:Configuration=Release /p:Platform=x64 /m /v:minimal
          }
        }
      continue-on-error: true

    - name: Prepare Intel Package
      run: |
        mkdir hyper-rev-intel
        mkdir hyper-rev-intel\scripts
        
        Get-ChildItem -Path hyper-rev-build -Recurse -Filter "uefi-boot.efi" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-intel\" }
        Get-ChildItem -Path hyper-rev-build -Recurse -Filter "hyperv-attachment.dll" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-intel\" }
        Get-ChildItem -Path hyper-rev-build -Recurse -Filter "usermode.exe" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-intel\" }
        
        Copy-Item "hyper-rev\scripts\*" "hyper-rev-intel\scripts\" -ErrorAction SilentlyContinue
        Copy-Item "hyper-rev\README.md" "hyper-rev-intel\" -ErrorAction SilentlyContinue
        Copy-Item "hyper-rev-build\load-hyper-reV.bat" "hyper-rev-intel\" -ErrorAction SilentlyContinue
        
        $buildInfo = "hyper-reV Package (Intel)`nArchitecture: Intel (EPT)`nBuild Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n`nUsage:`n1. Run 02-backup-bootloader.bat`n2. Run load-hyper-reV.bat (Admin)`n3. Reboot"
        Set-Content "hyper-rev-intel\BUILD_INFO.txt" $buildInfo
        
        Write-Host "Intel package contents:"
        Get-ChildItem hyper-rev-intel

    - name: Upload Intel Package
      uses: actions/upload-artifact@v4
      with:
        name: hyper-rev-intel
        path: hyper-rev-intel/
        retention-days: 30

  # ============================================
  # JOB 3: Build for AMD
  # ============================================
  build-amd:
    name: Build for AMD (NPT)
    runs-on: windows-latest
    needs: prepare
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install NASM
      run: |
        $nasmVersion = "2.16.01"
        Invoke-WebRequest -Uri "https://www.nasm.us/pub/nasm/releasebuilds/$nasmVersion/win64/nasm-$nasmVersion-win64.zip" -OutFile "$env:TEMP\nasm.zip" -UseBasicParsing
        Expand-Archive -Path "$env:TEMP\nasm.zip" -DestinationPath "C:\" -Force
        Rename-Item "C:\nasm-$nasmVersion" "C:\NASM"
        echo "NASM_PREFIX=C:\NASM\" >> $env:GITHUB_ENV
        echo "C:\NASM" >> $env:GITHUB_PATH

    - name: Download prepared source
      uses: actions/download-artifact@v4
      with:
        name: hyper-rev-source
        path: hyper-rev-build/

    - name: Configure for AMD
      run: |
        $configFile = "hyper-rev-build\hyperv-attachment\src\arch_config.h"
        
        if (Test-Path $configFile) {
          $content = Get-Content $configFile -Raw
          $content = $content -replace '#define\s+_INTELMACHINE', '//#define _INTELMACHINE'
          $content = $content -replace '//\s*#define\s+_AMDMACHINE', '#define _AMDMACHINE'
          Set-Content $configFile $content
          Write-Host "Configured for AMD"
          Get-Content $configFile
        } else {
          Write-Host "Creating arch_config.h for AMD..."
          New-Item -Path (Split-Path $configFile) -ItemType Directory -Force
          Set-Content $configFile "#pragma once`n//#define _INTELMACHINE`n#define _AMDMACHINE"
        }

    - name: Build uefi-boot.efi
      run: |
        cd hyper-rev-build\uefi-boot
        $slnFile = Get-ChildItem -Filter "*.sln" | Select-Object -First 1
        if ($slnFile) {
          msbuild $slnFile.Name /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        }
      continue-on-error: true

    - name: Build hyperv-attachment.dll
      run: |
        cd hyper-rev-build\hyperv-attachment
        $slnFile = Get-ChildItem -Filter "*.sln" | Select-Object -First 1
        if ($slnFile) {
          msbuild $slnFile.Name /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        } else {
          $vcxFile = Get-ChildItem -Filter "*.vcxproj" | Select-Object -First 1
          if ($vcxFile) {
            msbuild $vcxFile.Name /p:Configuration=Release /p:Platform=x64 /m /v:minimal
          }
        }
      continue-on-error: true

    - name: Prepare AMD Package
      run: |
        mkdir hyper-rev-amd
        mkdir hyper-rev-amd\scripts
        
        Get-ChildItem -Path hyper-rev-build -Recurse -Filter "uefi-boot.efi" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-amd\" }
        Get-ChildItem -Path hyper-rev-build -Recurse -Filter "hyperv-attachment.dll" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-amd\" }
        Get-ChildItem -Path hyper-rev-build -Recurse -Filter "usermode.exe" | ForEach-Object { Copy-Item $_.FullName "hyper-rev-amd\" }
        
        Copy-Item "hyper-rev\scripts\*" "hyper-rev-amd\scripts\" -ErrorAction SilentlyContinue
        Copy-Item "hyper-rev\README.md" "hyper-rev-amd\" -ErrorAction SilentlyContinue
        Copy-Item "hyper-rev-build\load-hyper-reV.bat" "hyper-rev-amd\" -ErrorAction SilentlyContinue
        
        $buildInfo = "hyper-reV Package (AMD)`nArchitecture: AMD (NPT)`nBuild Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n`nUsage:`n1. Run 02-backup-bootloader.bat`n2. Run load-hyper-reV.bat (Admin)`n3. Reboot"
        Set-Content "hyper-rev-amd\BUILD_INFO.txt" $buildInfo
        
        Write-Host "AMD package contents:"
        Get-ChildItem hyper-rev-amd

    - name: Upload AMD Package
      uses: actions/upload-artifact@v4
      with:
        name: hyper-rev-amd
        path: hyper-rev-amd/
        retention-days: 30

  # ============================================
  # JOB 4: Build Cheat
  # ============================================
  build-cheat:
    name: Build Cheat
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          cheats/externa-rust-v2/target
        key: cargo-${{ runner.os }}-${{ hashFiles('cheats/externa-rust-v2/Cargo.lock') }}

    - name: Build Cheat
      run: |
        cd cheats\externa-rust-v2
        cargo build --release

    - name: Upload Cheat
      uses: actions/upload-artifact@v4
      with:
        name: externa-rust-v2
        path: cheats/externa-rust-v2/target/release/externa-rust-v2.exe
        retention-days: 30
