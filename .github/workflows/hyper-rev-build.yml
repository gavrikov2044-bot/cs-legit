name: Build hyper-reV

on:
  push:
    branches: [main]
    paths:
      - 'hyper-rev/**'
      - '.github/workflows/hyper-rev-build.yml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # JOB 1: Prepare - Clone and build EDK2
  # ============================================
  prepare:
    name: Prepare & Build EDK2
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install NASM
      run: |
        choco install nasm -y --no-progress
        $nasmPath = "C:\Program Files\NASM"
        echo "NASM_PREFIX=$nasmPath\" >> $env:GITHUB_ENV
        echo "$nasmPath" >> $env:GITHUB_PATH
        nasm -v
      shell: pwsh

    - name: Clone hyper-reV with submodules
      run: |
        Write-Host "=== Cloning hyper-reV ==="
        git clone https://github.com/noahware/hyper-reV.git hyper-rev-build
        cd hyper-rev-build
        
        Write-Host "=== Initializing submodules ==="
        git submodule update --init --recursive
        
        # Verify submodules
        Write-Host "=== Checking submodules ==="
        
        if (-not (Test-Path "uefi-boot\ext\edk2\src\build\EDK-II.sln")) {
          Write-Host "EDK2 submodule missing, cloning manually..."
          New-Item -ItemType Directory -Force -Path "uefi-boot\ext\edk2\src" | Out-Null
          git clone https://github.com/ionescu007/edk2.git uefi-boot/ext/edk2/src
        }
        
        if (-not (Test-Path "uefi-boot\ext\openssl\Configure")) {
          Write-Host "OpenSSL submodule missing, cloning manually..."
          git clone --branch OpenSSL_1_1_0-stable --depth 1 https://github.com/openssl/openssl.git uefi-boot/ext/openssl
        }
        
        Write-Host "=== Repository structure ==="
        Get-ChildItem
        Get-ChildItem uefi-boot\ext -ErrorAction SilentlyContinue
      shell: pwsh

    - name: Cache EDK2 Build
      id: cache-edk2
      uses: actions/cache@v4
      with:
        path: hyper-rev-build/uefi-boot/ext/edk2/src/build/x64
        key: edk2-v4-${{ runner.os }}

    - name: Build EDK2 Libraries
      if: steps.cache-edk2.outputs.cache-hit != 'true'
      run: |
        $edkSln = "hyper-rev-build\uefi-boot\ext\edk2\src\build\EDK-II.sln"
        
        if (Test-Path $edkSln) {
          Write-Host "Building EDK-II.sln..."
          cd "hyper-rev-build\uefi-boot\ext\edk2\src\build"
          msbuild EDK-II.sln /p:Configuration=Release /p:Platform=x64 /m /v:minimal
        } else {
          Write-Host "ERROR: EDK-II.sln not found at $edkSln"
          Write-Host "Searching for solution files..."
          Get-ChildItem -Path hyper-rev-build -Recurse -Filter "*.sln" | Select-Object -First 20
          exit 1
        }
      shell: pwsh

    - name: Upload prepared source
      uses: actions/upload-artifact@v4
      with:
        name: hyper-rev-source
        path: hyper-rev-build/
        retention-days: 1

  # ============================================
  # JOB 2: Build for Intel
  # ============================================
  build-intel:
    name: Build for Intel (EPT)
    runs-on: windows-latest
    needs: prepare
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install NASM
      run: |
        choco install nasm -y --no-progress
        $nasmPath = "C:\Program Files\NASM"
        echo "NASM_PREFIX=$nasmPath\" >> $env:GITHUB_ENV
        echo "$nasmPath" >> $env:GITHUB_PATH
      shell: pwsh

    - name: Download prepared source
      uses: actions/download-artifact@v4
      with:
        name: hyper-rev-source
        path: hyper-rev-build/

    - name: Configure for Intel
      run: |
        $configFile = "hyper-rev-build\hyperv-attachment\src\arch_config.h"
        
        if (Test-Path $configFile) {
          Write-Host "Configuring for Intel..."
          $content = Get-Content $configFile -Raw
          $content = $content -replace '//\s*#define\s+_INTELMACHINE', '#define _INTELMACHINE'
          $content = $content -replace '#define\s+_AMDMACHINE', '//#define _AMDMACHINE'
          Set-Content $configFile $content
          Get-Content $configFile
        } else {
          Write-Host "Creating arch_config.h for Intel..."
          New-Item -Path (Split-Path $configFile) -ItemType Directory -Force
          "#pragma once`n#define _INTELMACHINE`n//#define _AMDMACHINE" | Set-Content $configFile
        }
      shell: pwsh

    - name: Build hyper-reV
      run: |
        cd hyper-rev-build
        
        Write-Host "=== Building hyper-reV.sln ==="
        if (Test-Path "hyper-reV.sln") {
          msbuild hyper-reV.sln /p:Configuration=Release /p:Platform=x64 /m /v:normal
        } else {
          Write-Host "ERROR: hyper-reV.sln not found!"
          Get-ChildItem
          exit 1
        }
      shell: pwsh
      continue-on-error: true

    - name: Collect Build Outputs
      run: |
        mkdir hyper-rev-intel -Force
        
        Write-Host "=== Searching for build outputs ==="
        
        # Find and copy uefi-boot.efi
        $uefi = Get-ChildItem -Path hyper-rev-build -Recurse -Filter "uefi-boot.efi" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($uefi) {
          Copy-Item $uefi.FullName "hyper-rev-intel\"
          Write-Host "Found: $($uefi.FullName)"
        } else {
          Write-Host "WARNING: uefi-boot.efi not found"
        }
        
        # Find and copy hyperv-attachment.dll
        $dll = Get-ChildItem -Path hyper-rev-build -Recurse -Filter "hyperv-attachment.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($dll) {
          Copy-Item $dll.FullName "hyper-rev-intel\"
          Write-Host "Found: $($dll.FullName)"
        } else {
          Write-Host "WARNING: hyperv-attachment.dll not found"
        }
        
        # Find and copy usermode.exe
        $exe = Get-ChildItem -Path hyper-rev-build -Recurse -Filter "usermode.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($exe) {
          Copy-Item $exe.FullName "hyper-rev-intel\"
          Write-Host "Found: $($exe.FullName)"
        } else {
          Write-Host "WARNING: usermode.exe not found"
        }
        
        # Copy load script
        if (Test-Path "hyper-rev-build\load-hyper-reV.bat") {
          Copy-Item "hyper-rev-build\load-hyper-reV.bat" "hyper-rev-intel\"
        }
        
        # Copy our scripts
        if (Test-Path "hyper-rev\scripts") {
          Copy-Item "hyper-rev\scripts\*" "hyper-rev-intel\" -ErrorAction SilentlyContinue
        }
        
        # Create info file
        $readme = "hyper-reV Package (Intel)`n"
        $readme += "==========================`n"
        $readme += "Architecture: Intel (EPT)`n"
        $readme += "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n`n"
        $readme += "Usage:`n1. Backup your bootloader first!`n2. Run load-hyper-reV.bat as Administrator`n3. Reboot`n"
        Set-Content "hyper-rev-intel\README.txt" $readme
        
        Write-Host "=== Package contents ==="
        Get-ChildItem hyper-rev-intel
      shell: pwsh

    - name: Upload Intel Package
      uses: actions/upload-artifact@v4
      with:
        name: hyper-rev-intel
        path: hyper-rev-intel/
        retention-days: 30
        if-no-files-found: warn

  # ============================================
  # JOB 3: Build for AMD
  # ============================================
  build-amd:
    name: Build for AMD (NPT)
    runs-on: windows-latest
    needs: prepare
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v2

    - name: Install NASM
      run: |
        choco install nasm -y --no-progress
        $nasmPath = "C:\Program Files\NASM"
        echo "NASM_PREFIX=$nasmPath\" >> $env:GITHUB_ENV
        echo "$nasmPath" >> $env:GITHUB_PATH
      shell: pwsh

    - name: Download prepared source
      uses: actions/download-artifact@v4
      with:
        name: hyper-rev-source
        path: hyper-rev-build/

    - name: Configure for AMD
      run: |
        $configFile = "hyper-rev-build\hyperv-attachment\src\arch_config.h"
        
        if (Test-Path $configFile) {
          Write-Host "Configuring for AMD..."
          $content = Get-Content $configFile -Raw
          $content = $content -replace '#define\s+_INTELMACHINE', '//#define _INTELMACHINE'
          $content = $content -replace '//\s*#define\s+_AMDMACHINE', '#define _AMDMACHINE'
          Set-Content $configFile $content
          Get-Content $configFile
        } else {
          Write-Host "Creating arch_config.h for AMD..."
          New-Item -Path (Split-Path $configFile) -ItemType Directory -Force
          "#pragma once`n//#define _INTELMACHINE`n#define _AMDMACHINE" | Set-Content $configFile
        }
      shell: pwsh

    - name: Build hyper-reV
      run: |
        cd hyper-rev-build
        
        Write-Host "=== Building hyper-reV.sln ==="
        if (Test-Path "hyper-reV.sln") {
          msbuild hyper-reV.sln /p:Configuration=Release /p:Platform=x64 /m /v:normal
        } else {
          Write-Host "ERROR: hyper-reV.sln not found!"
          Get-ChildItem
          exit 1
        }
      shell: pwsh
      continue-on-error: true

    - name: Collect Build Outputs
      run: |
        mkdir hyper-rev-amd -Force
        
        Write-Host "=== Searching for build outputs ==="
        
        $uefi = Get-ChildItem -Path hyper-rev-build -Recurse -Filter "uefi-boot.efi" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($uefi) { Copy-Item $uefi.FullName "hyper-rev-amd\"; Write-Host "Found: $($uefi.FullName)" }
        
        $dll = Get-ChildItem -Path hyper-rev-build -Recurse -Filter "hyperv-attachment.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($dll) { Copy-Item $dll.FullName "hyper-rev-amd\"; Write-Host "Found: $($dll.FullName)" }
        
        $exe = Get-ChildItem -Path hyper-rev-build -Recurse -Filter "usermode.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($exe) { Copy-Item $exe.FullName "hyper-rev-amd\"; Write-Host "Found: $($exe.FullName)" }
        
        if (Test-Path "hyper-rev-build\load-hyper-reV.bat") {
          Copy-Item "hyper-rev-build\load-hyper-reV.bat" "hyper-rev-amd\"
        }
        
        $readme = "hyper-reV Package (AMD)`n"
        $readme += "========================`n"
        $readme += "Architecture: AMD (NPT)`n"
        $readme += "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n`n"
        $readme += "Usage:`n1. Backup your bootloader first!`n2. Run load-hyper-reV.bat as Administrator`n3. Reboot`n"
        Set-Content "hyper-rev-amd\README.txt" $readme
        
        Write-Host "=== Package contents ==="
        Get-ChildItem hyper-rev-amd
      shell: pwsh

    - name: Upload AMD Package
      uses: actions/upload-artifact@v4
      with:
        name: hyper-rev-amd
        path: hyper-rev-amd/
        retention-days: 30
        if-no-files-found: warn

  # ============================================
  # JOB 4: Build Cheat
  # ============================================
  build-cheat:
    name: Build Cheat
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          cheats/externa-rust-v2/target
        key: cargo-${{ runner.os }}-${{ hashFiles('cheats/externa-rust-v2/Cargo.lock') }}

    - name: Build Cheat
      run: |
        cd cheats\externa-rust-v2
        cargo build --release

    - name: Upload Cheat
      uses: actions/upload-artifact@v4
      with:
        name: externa-rust-v2
        path: cheats/externa-rust-v2/target/release/externa-rust-v2.exe
        retention-days: 30
