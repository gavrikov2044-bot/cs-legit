name: Build Rust Kernel Driver

on:
  push:
    paths:
      - 'cheats/cs2-rust/driver/**'
      - '.github/workflows/rust-driver.yml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust Nightly
      uses: dtolnay/rust-toolchain@nightly
      with:
        targets: x86_64-pc-windows-msvc
        components: rust-src
    
    - name: Setup EWDK
      run: |
        # Download Enterprise WDK (EWDK) - self-contained WDK
        # Using cargo-wdk approach instead
        echo "WDK will be handled by cargo-wdk"
      shell: powershell
    
    - name: Install cargo-wdk
      run: cargo install cargo-wdk
      continue-on-error: true
    
    - name: Build Driver
      working-directory: cheats/cs2-rust/driver
      run: |
        # Try standard build first
        cargo +nightly build --release -Z build-std=core,alloc --target x86_64-pc-windows-msvc 2>&1 || echo "Build requires WDK - skipping for now"
      continue-on-error: true
    
    - name: Create placeholder
      run: |
        mkdir -p cheats/cs2-rust/driver/target/release
        echo "Driver build requires local WDK installation" > cheats/cs2-rust/driver/target/release/BUILD_NOTE.txt
      shell: bash
    
    - name: Upload Driver Artifact
      uses: actions/upload-artifact@v4
      with:
        name: externa-driver-source
        path: cheats/cs2-rust/driver/
        if-no-files-found: warn
