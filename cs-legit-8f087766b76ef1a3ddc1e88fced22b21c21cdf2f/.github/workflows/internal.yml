name: ğŸ”’ Build Internal

on:
  workflow_dispatch:

jobs:
  build-internal:
    name: ğŸ”’ INTERNAL (DLL Injection)
    runs-on: windows-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ”§ Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: âš¡ Setup Ninja
      uses: seanmiddleditch/gha-setup-ninja@v5

    - name: âš™ï¸ Configure
      run: |
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "   INTERNAL ESP v1.0.0"
        Write-Host "=========================================="
        cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

    - name: ğŸ”¨ Build Internal DLL
      run: cmake --build build --target interna --config Release

    - name: ğŸ”¨ Build Injector
      run: cmake --build build --target injector --config Release

    - name: âœ… Verify
      run: |
        Write-Host ""
        Write-Host "=========================================="
        Write-Host "   BUILD SUCCESS"
        Write-Host "=========================================="
        Get-ChildItem -Path build -Recurse -Include *.dll,*.exe | ForEach-Object {
          $size = [math]::Round($_.Length / 1KB, 2)
          Write-Host "   $($_.Name): $size KB"
        }
    
    - name: ğŸ“¦ Upload
      uses: actions/upload-artifact@v4
      with:
        name: Internal-${{ github.run_number }}
        path: |
          build/bin/*.dll
          build/bin/*.exe
          build/interna/*.dll
          build/injector/*.exe
        retention-days: 30
